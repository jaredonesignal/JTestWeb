<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OneSignal Push Receiver â€” JTestWeb</title>

  <!-- OneSignal Web SDK v16 -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
           background:#0b1020; color:#e5e7eb; margin:0; min-height:100vh;
           display:grid; place-items:center; }
    .card { background:#111827; border:1px solid #1f2937; border-radius:16px; padding:24px; max-width:560px; width:92%; }
    button { background:#3b82f6; border:none; color:white; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer; }
    code { background:#0f172a; padding:8px 12px; border-radius:8px; color:#93c5fd; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; white-space:pre-wrap; background:#0f172a; border:1px solid #1f2937; border-radius:8px; padding:10px; margin-top:12px; }
    .muted { color:#9ca3af; font-size:14px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>ðŸ”” OneSignal Web Push Receiver (JTestWeb)</h2>
    <p class="muted">Click to enable notifications and get your Subscription (Player) ID.</p>
    <button id="enable">Enable Notifications</button>

    <p style="margin-top:16px;">Subscription ID:</p>
    <code id="playerId">â€”</code>

    <div id="log" class="log" aria-live="polite"></div>
  </div>

  <script>
    const APP_ID = "4bd637c1-11d5-46bf-b1c3-c203b648b25e"; // your App ID
    const REPO = "JTestWeb";              // your repo name
    const SAFARI_WEB_ID = undefined;      // set if testing Safari

    const $ = (id) => document.getElementById(id);
    const log = (m) => { $("log").textContent += `${new Date().toLocaleTimeString()} â€” ${m}\n`; };

    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      try {
        log("Initializing OneSignalâ€¦");

        await OneSignal.init({
          appId: APP_ID,
          safari_web_id: SAFARI_WEB_ID,
          allowLocalhostAsSecureOrigin: true,
          // Required for GitHub Pages *project* sites:
          serviceWorkerPath: `/${REPO}/OneSignalSDKWorker.js`,
          serviceWorkerParam: { scope: `/${REPO}/` },
        });

        log("SDK initialized.");

        // Listen for subscription changes and show the new ID as soon as itâ€™s assigned
        OneSignal.User.PushSubscription.addEventListener("change", (event) => {
          const id = event?.current?.id || "";
          $("playerId").textContent = id || "â€”";
          log("PushSubscription change:\n" + JSON.stringify(event, null, 2));
        });

        await refreshStatus(OneSignal);

        $("enable").addEventListener("click", async () => {
          try {
            // Request native permission
            const previous = OneSignal.Notifications.permission;
            log(`Permission before: ${previous}`);
            await OneSignal.Notifications.requestPermission();

            // Opt the current subscription in (shows prompt if needed)
            log("Opting inâ€¦");
            await OneSignal.User.PushSubscription.optIn();

            await refreshStatus(OneSignal);
          } catch (e) {
            log("Error during permission/opt-in: " + (e.message || e));
          }
        });
      } catch (e) {
        log("Init error: " + (e.message || e));
      }
    });

    async function refreshStatus(OneSignal) {
      // v16: permission is a boolean; subscription status is `optedIn`
      const permission = OneSignal.Notifications.permission; // true/false
      const optedIn = OneSignal.User.PushSubscription.optedIn; // true/false
      let id = "";
      try { id = OneSignal.User.PushSubscription.id || ""; } catch (_) {}
      $("playerId").textContent = id || "â€”";
      log(JSON.stringify({ permission, optedIn, id }, null, 2));
    }
  </script>
</body>
</html>
